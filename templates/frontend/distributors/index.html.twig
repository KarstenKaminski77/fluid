{% extends 'layout_distributor.html.twig' %}

{% block title %}Hello DistributorsController!{% endblock %}

{% block body %}
    <div class="hidden users-flash mb-0" id="flash"></div>
    <div class="container-fluid pe-sm-4">
        <div class="row flex-nowrap">
            <div class="col-2 col-sm-2 col-md-3 col-xl-2 px-sm-2 px-0 bg-light border-right distributor-left-col">
                <div class="d-flex flex-column align-items-center align-items-sm-start px-3 pt-2 text-white min-vh-100 text-truncate overflow-hidden">
                    <ul class="nav nav-pills flex-column mb-sm-auto mb-0 align-items-center align-items-sm-start w-100 mt-4" id="menu">
                        <li class="nav-item py-3 w-100">
                            {% if distributor.isApproved == 1 %}
                                {% set tag = 'a' %}
                                {% set id = 'customers_link' %}
                                {% set disabled = '' %}
                            {% else %}
                                {% set tag = 'span' %}
                                {% set id = '' %}
                                {% set disabled = 'text-disabled' %}
                            {% endif %}
                            <{{ tag }} href="#" class="align-middle px-0 text-primary nav-icon text-truncate {{ disabled }}" id="{{ id }}">
                                <i class="fa-regular fa-users fa-fw"></i>
                                <span class="ms-1 d-none d-sm-inline">Customers</span>
                            </{{ tag }}>
                        </li>
                        <li class="w-100" data-controller="distributors--my-account distributors--users">
                            <a
                                href="#submenu1"
                                data-bs-toggle="collapse"
                                class="px-0 align-middle text-primary collapsed text-center text-sm-start nav-icon mb-3 text-truncate dropdown-link"
                                aria-expanded="false"
                            >
                                <i class="fa-regular fa-user-gear fa-fw"></i>
                                <span class="ms-1 d-none d-sm-inline">My Account</span>
                                <span class="float-end d-none d-sm-inline">
                                    <i class="fa-solid fa-caret-right"></i>
                                </span>
                            </a>
                            <ul class="nav flex-column collapse" id="submenu1" data-bs-parent="#menu" style="">
                                <li class="w-100 mb-3">
                                    {% if 10 in permissions %}
                                        <a
                                            href="#"
                                            class="align-middle text-primary nav-icon text-truncate"
                                            id="account_settings_link"
                                            data-action="distributors--my-account#onClickCompanyInformation"
                                        >
                                            <i class="fa-regular fa-screwdriver-wrench fa-fw"></i>
                                            <span class="ms-1 d-none d-sm-inline">Company Information</span>
                                        </a>
                                    {% else %}
                                        <span class="align-middle text-primary nav-icon text-truncate text-disabled">
                                            <i class="fa-regular fa-screwdriver-wrench fa-fw"></i>
                                            <span class="ms-1 d-none d-sm-inline">Company Information</span>
                                        </span>
                                    {% endif %}
                                </li>
                                <li class="w-100 mb-3">
                                    {% if 15 in permissions and distributor.isApproved == 1 %}
                                        <a
                                            href="#"
                                            class="align-middle text-primary nav-icon text-truncate"
                                            id="about_link"
                                            data-action="click->distributors--my-account#onClickAbout"
                                        >
                                            <i class="fa-regular fa-circle-question fa-fw"></i>
                                            <span class="ms-1 d-none d-sm-inline">About</span>
                                        </a>
                                    {% else %}
                                        <span class="align-middle text-primary nav-icon text-truncate text-disabled">
                                            <i class="fa-regular fa-circle-question fa-fw"></i>
                                            <span class="ms-1 d-none d-sm-inline">About</span>
                                        </span>
                                    {% endif %}

                                </li>
                                <li class="w-100 mb-3">
                                    {% if 16 in permissions and distributor.isApproved == 1 %}
                                        <a
                                            href="#"
                                            class="align-middle text-primary nav-icon text-truncate"
                                            id="operating_hours_link"
                                            data-action="click->distributors--my-account#onClickOperatingHours"
                                        >
                                            <i class="fa-regular fa-clock fa-fw"></i>
                                            <span class="ms-1 d-none d-sm-inline">Operating Hours</span>
                                        </a>
                                    {% else %}
                                        <span class="align-middle text-primary nav-icon text-truncate text-disabled">
                                            <i class="fa-regular fa-clock fa-fw"></i>
                                            <span class="ms-1 d-none d-sm-inline">Operating Hours</span>
                                        </span>
                                    {% endif %}
                                </li>
                                <li class="w-100 mb-3">
                                    {% if 17 in permissions and distributor.isApproved == 1 %}
                                        <a
                                            href="#"
                                            class="align-middle text-primary nav-icon text-truncate"
                                            id="refund_policy_link"
                                            data-action="click->distributors--my-account#onClickRefundPolicy"
                                        >
                                            <i class="fa-solid fa-rotate-left fa-fw"></i>
                                            <span class="ms-1 d-none d-sm-inline">Refund Policy</span>
                                        </a>
                                    {% else %}
                                        <span href="#" class="align-middle text-primary nav-icon text-truncate text-disabled">
                                            <i class="fa-solid fa-rotate-left fa-fw"></i>
                                            <span class="ms-1 d-none d-sm-inline">Refund Policy</span>
                                        </span>
                                    {% endif %}
                                </li>
                                <li class="w-100 mb-3">
                                    {% if 18 in permissions and distributor.isApproved == 1 %}
                                        <a
                                            href="#"
                                            class="align-middle text-primary nav-icon text-truncate"
                                            id="sales_tax_policy_link"
                                            data-action="click->distributors--my-account#onClickSalesTaxPolicy"
                                        >
                                            <i class="fa-regular fa-scale-unbalanced fa-fw"></i>
                                            <span class="ms-1 d-none d-sm-inline">Sale Tax Policy</span>
                                        </a>
                                    {% else %}
                                        <span class="align-middle text-primary nav-icon text-truncate text-disabled">
                                            <i class="fa-regular fa-scale-unbalanced fa-fw"></i>
                                            <span class="ms-1 d-none d-sm-inline">Sale Tax Policy</span>
                                        </span>
                                    {% endif %}
                                </li>
                                <li class="w-100 mb-3">
                                    {% if 19 in permissions and distributor.isApproved == 1 %}
                                        <a
                                            href="#"
                                            class="align-middle text-primary nav-icon text-truncate"
                                            id="shipping_policy_link"
                                            data-action="click->distributors--my-account#onClickShippingPolicy"
                                        >
                                            <i class="fa-regular fa-truck-ramp-box fa-fw"></i>
                                            <span class="ms-1 d-none d-sm-inline">Shipping Policy</span>
                                        </a>
                                    {% else %}
                                        <span class="align-middle text-primary nav-icon text-truncate text-disabled">
                                            <i class="fa-regular fa-truck-ramp-box fa-fw"></i>
                                            <span class="ms-1 d-none d-sm-inline">Shipping Policy</span>
                                        </span>
                                    {% endif %}
                                </li>
                                <li class="w-100 mb-3">
                                    {% if 6 in permissions and distributor.isApproved == 1 %}
                                        <a
                                            class="align-middle text-primary nav-icon text-truncate"
                                            href="#"
                                            id="users_link"
                                            data-action="click->distributors--users#onClickUsers"
                                        >
                                            <i class="fa-regular fa-address-book fa-fw"></i>
                                            <span class="ms-1 d-none d-sm-inline">Users</span>
                                        </a>
                                    {% else %}
                                        <span class="align-middle text-primary nav-icon text-truncate text-disabled">
                                            <i class="fa-regular fa-address-book fa-fw"></i>
                                            <span class="ms-1 d-none d-sm-inline">Users</span>
                                        </span>
                                    {% endif %}
                                </li>
                            </ul>
                        </li>
                        <li class="w-100">
                            {% if 5 in permissions and distributor.isApproved == 1 %}
                                <a
                                        href="#"
                                        class="px-0 align-middle text-primary nav-icon mb-3 text-truncate"
                                        data-distributor-id="{{ distributor.id }}"
                                        id="orders_link"
                                >
                                    <i class="fa-regular fa-file-invoice fa-fw"></i>
                                    <span class="ms-1 d-none d-sm-inline">Orders</span>
                                </a>
                            {% else %}
                                <span
                                        class="px-0 align-middle text-primary nav-icon mb-3 text-truncate text-disabled"
                                        data-distributor-id="{{ distributor.id }}"
                                >
                                    <i class="fa-regular fa-file-invoice fa-fw"></i>
                                    <span class="ms-1 d-none d-sm-inline">Orders</span>
                                </span>
                            {% endif %}
                        </li>
                        <li class="w-100" data-controller="products--distributor-products">
                            {% if distributor.isApproved == 1 %}
                                {% set tag = 'a' %}
                                {% set href = '#submenu2' %}
                                {% set disabled = '' %}
                            {% else %}
                                {% set tag = 'span' %}
                                {% set href = '' %}
                                {% set disabled = 'text-disabled' %}
                            {% endif %}
                            <{{ tag }}
                                href="{{ href }}"
                                data-bs-toggle="collapse"
                                class="px-0 align-middle text-primary collapsed text-center text-sm-start nav-icon mb-3 text-truncate {{ disabled }}"
                                aria-expanded="false"
                            >
                                <i class="fa-regular fa-cart-flatbed fa-fw"></i>
                                <span class="ms-1 d-none d-sm-inline">Inventory</span>
                            </{{ tag }}>
                            {% if 20 in permissions %}
                                <ul class="nav flex-column collapse" id="submenu2" data-bs-parent="#menu" style="">
                                    <li class="w-100 mb-3">
                                        <a
                                            href="#"
                                            class="align-middle text-primary nav-icon text-truncate"
                                            id="inventory_link"
                                        >
                                            <i class="fa-regular fa-square-plus fa-fw"></i>
                                            <span class="ms-1 d-none d-sm-inline">Attatch New</span>
                                        </a>
                                    </li>
                                    <li class="w-100 mb-3">
                                        <a
                                            href="#" class="align-middle text-primary nav-icon text-truncate"
                                            id="inventory_list_link"
                                            data-action="click->products--distributor-products#onClickInventoryList"
                                        >
                                            <i class="fa-regular fa-shelves fa-fw"></i>
                                            <span class="ms-1 d-none d-sm-inline">List</span>
                                        </a>
                                    </li>
                                </ul>
                            {% else %}
                                <span class="px-0 align-middle text-primary nav-icon mb-3 text-truncate text-disabled">
                                    <i class="fa-regular fa-cart-flatbed fa-fw"></i>
                                    <span class="ms-1 d-none d-sm-inline">Invetory</span>
                                </span>
                            {% endif %}
                        </li>
                    </ul>
                </div>
            </div>
            <div class="col-10 col-sm-10 pb-3 distributor-right-col">

                {# Account & Settings #}
                <div
                    class="row"
                    id="distributor_container"
                    data-controller="distributors--my-account distributors--users products--distributor-products"
                >
                </div>
                {# End Account & Settings #}

                {# Orders #}
                <div id="order_container"></div>
                {# End Orders #}

                {# Customers #}
                <div id="customer_container"></div>
                {# End Customers #}

                {# Access Denied #}
                <div class="row hidden h-100 height-distributors" style="height: calc(100% - 56px)!important" id="access_denied">
                    <div class="col-12">
                        <table class="w-100 h-100">
                            <tr>
                                <td class="align-middle text-center">
                                    <div class="row">
                                        <div class="col-12 text-center">
                                            <i class="fa-solid fa-ban pe-2" style="font-size: 30vh; margin-bottom: 30px; color: #CCC;text-align: center"></i>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-12 text-center">
                                            <h1>Access Denied</h1>

                                            <p class="mt-4 mb-0">
                                                Your user account does not have permission to view the requested page.
                                            </p>
                                        </div>
                                    </div>
                                </td>
                            </tr>
                        </table>
                    </div>
                </div>
                {# End Access Denied #}
            </div>
        </div>
    </div>
    <div class="overlay"></div>
    <div class="spanner">
        <div class="loader"></div>
        <p class="text-light fw-bold" style="font-size: 36px;">Loading...</p>
    </div>
{% endblock %}

{% block javascripts %}
    {{ parent() }}

    <script>

        let uri = window.location.pathname;
        let isCompanyInfo = uri.match('/distributors/account');
        let isApproved = '{{ distributor.isApproved|default(0) }}';

        if(isApproved == 0 && isCompanyInfo == null)
        {
            window.location.href = '{{ app.request.schemeAndHttpHost }}/distributors/account';
        }

        $(document).ready(function()
        {
            $.session.set('permissions', JSON.stringify({{ permissions }}));
            $.session.set('distributor-id', '{{ distributor.id }}');
            $.session.set('trade-license-no', '{{ nzo_decrypt(distributor.tradeLicenseNo) }}');
            $.session.set('trade-license-file', '{{ distributor.tradeLicense }}');
            $.session.set('trade-license-exp', '{{ distributor.tradeLicenseExpDate|date('Y-m-d') }}');
            let input = '';
            let iti = '';

            function getFlash(flash, type = 'success'){
                $('#flash').addClass('alert-'+ type).addClass('alert').addClass('text-center');
                $('#flash').removeClass('users-flash').addClass('users-flash').empty().append(flash).removeClass('hidden');

                setTimeout(function() {
                    $('#flash').removeClass('alert-success').removeClass('alert').removeClass('text-center');
                    $('#flash').removeClass('users-flash').empty().addClass('hidden');
                }, 5000);
            }

            {# Dropdown Menu Chevron #}
            $(document).on('click', '.dropdown-link', function (e) {

                e.preventDefault();

                if($(this).attr('aria-expanded') == 'true')
                {
                    $(this).find('.fa-caret-right').css({'rotate':'90deg'});
                }
                else
                {
                    $(this).find('.fa-caret-right').css({'rotate':'0deg'});
                }
            });

            let brand = $('#brand');
            let account_settings = $('#account_settings');
            let about = $('#about');
            let operating_hours = $('#operating_hours');
            let refund_policy = $('#refund_policy');
            let sales_tax_policy = $('#sales_tax_policy');
            let shipping_policy = $('#shipping_policy');
            let inventory = $('#inventory');
            let inventory_search = $('#inventory_search');
            let inventory_item = $('#inventory_item');
            let inventoryList = $('#inventory_list_container');
            let users = $('#users');
            let inventory_clear = $('#inventory_clear');
            let inventory_btn = $('#inventory_btn');
            let order_container = $('#order_container');
            let customerContainer = $('#customer_container');
            let access_denied = $('#access_denied');
            let get_messages = '';
            let date = new Date();
            let date_time = date.getFullYear() +'-'+ (date.getMonth() + 1) +'-'+ date.getDate() +' '+ String(date.getHours()).padStart(2, "0") + ":" + String(date.getMinutes()).padStart(2, "0") +':'+ String(date.getSeconds()).padStart(2, '0');
            sessionStorage.setItem('date_time', date_time);

            inventory.hide();
            inventoryList.hide();
            inventory_item.hide();
            users.hide();
            order_container.hide();
            customerContainer.hide();
            $('#btn_inventory').hide();
            

            {# Get correct content on refresh #}
            let uri = '{{ app.request.requestUri }}';
            let is_shipping_policy = uri.match('/distributors/shipping-policy');
            let is_customers = uri.match('/distributors/customers');

            {# Customers #}
            if(is_customers != null) {

                getCustomersList();
            }

            {# Orders #}
            {# Orders List #}
            function getOrdersList(distributor_id, page_id, clinic_id = '', status_id = '', date = ''){

                $.ajax({
                    url: "{{ path('distributor_get_order_list') }}",
                    type: 'POST',
                    dataType: 'json',
                    data: {
                        page_id: page_id,
                        distributor_id: distributor_id,
                        clinic_id: clinic_id,
                        status_id: status_id,
                        date: date,
                    },
                    beforeSend: function () {
                        $("div.spanner").addClass("show");
                        $("div.overlay").addClass("show");
                    },
                    complete: function(e, xhr, settings){
                        if(e.status === 500){
                            window.location.href = '{{ path('distributor_error_500') }}';
                        }
                    },
                    success: function (response) {
                        $('#order_container').empty().append(response.html).append(response.pagination);
                        account_settings.hide();
                        about.hide();
                        operating_hours.hide();
                        refund_policy.hide();
                        sales_tax_policy.hide();
                        shipping_policy.hide();
                        inventory.hide();
                        inventoryList.hide();
                        inventory_item.hide();
                        users.hide();
                        order_container.show();
                        customerContainer.hide();
                        $("div.spanner").removeClass("show");
                        $("div.overlay").removeClass("show");
                        $('#filter_row_toggle').removeClass('border-bottom');

                        window.history.pushState(null, "Fluid", '/distributors/orders/'+ distributor_id);

                        let selector = '#datepicker';

                        if ($(window).width() < 769){

                            selector = '#datepicker_mobile';
                            $('.clinic_select').removeClass('me-2');
                            $('.status_select').removeClass('me-2 ms-3');
                        }

                        if($('#filter_row').is( ":visible" )){

                            $('#filter_row_toggle').removeClass('border-bottom');
                            $('#filter_row_toggle').addClass('border-bottom');
                        }

                        const picker = new easepick.create({
                            element: selector,
                            css: [
                                'https://cdn.jsdelivr.net/npm/@easepick/bundle@1.2.0/dist/index.css',
                                '{{ asset('css/date_picker.min.css') }}',
                            ],
                            zIndex: 11,
                            readonly: false,
                            plugins: [
                                "AmpPlugin",
                                "RangePlugin",
                            ]
                        })
                    }
                });
            }

            $('#orders_link').click(function (e){

                e.preventDefault();

                account_settings.hide();
                about.hide();
                operating_hours.hide();
                refund_policy.hide();
                sales_tax_policy.hide();
                shipping_policy.hide();
                inventory.hide();
                inventoryList.hide();
                inventory_item.hide();
                users.hide();
                order_container.empty().show();
                brand.empty().hide();

                getOrdersList($(this).data('distributor-id'), 1);
            });
            $(document).on('click', '.orders_link', function (e){

                e.preventDefault();

                account_settings.hide();
                about.hide();
                operating_hours.hide();
                refund_policy.hide();
                sales_tax_policy.hide();
                shipping_policy.hide();
                inventory.hide();
                inventoryList.hide();
                inventory_item.hide();
                users.hide();
                order_container.empty().show();
                brand.empty().hide();

                getOrdersList($(this).data('distributor-id'), 1);
            });
            $(document).on('click','.order-link', function (e){

                let distributor_id = window.location.pathname.split('/')[3];

                e.preventDefault();
                clearInterval(get_messages);
                getOrdersList(distributor_id, $(this).data('page-id'));

            });
            $(document).on('change', '.clinic_select', function (){
                $('.clinic_search').attr('data-clinic-id', $(this).val());
            });
            setInterval(function(){

                if($('#datepicker_mobile').val() != '' && $('#datepicker_mobile').val() != 'Date') {

                    $('.clinic_search').attr('data-date', $('#datepicker_mobile').val());
                }

                if($('#datepicker').val() != '' && $('#datepicker').val() != 'Date') {

                    $('.clinic_search').attr('data-date', $('#datepicker').val());
                }
            } , 1000);
            $(document).on('change', '.status_select', function (){
                $('.clinic_search').attr('data-status-id', $(this).val());
            });
            $(document).on('click', '.clinic_refresh', function (){

                $('.datepicker').val('');
                $('.clinic_select').val('');
                $('.status_select').val('');

                let distributor_id = $(this).data('distributor-id');

                getOrdersList(distributor_id, 1);
            });
            $(document).on('click', '.clinic_search', function (){
                let distributor_id = $(this).data('distributor-id');
                let date = $(this).data('date');
                let clinic_id = $(this).data('clinic-id');
                let status = $(this).data('status-id');

                getOrdersList(distributor_id, 1, clinic_id, status, date);
            });
            $(document).on('click', '#filter_orders', function (){
                $('#filter_row').toggle(700, 'linear');

                setInterval(function(){

                    if($('#filter_row').is( ":visible" )){

                        $('#filter_row_toggle').addClass('border-bottom');

                    } else {

                        $('#filter_row_toggle').removeClass('border-bottom');
                    }
                } , 1000);
            });
            {# Order Details #}
            let is_order_detail = uri.match('/distributors/order/[0-9]+');
            let is_order_list = uri.match('/distributors/orders/[0-9]+');

            let orderid = '{{app.request.get('order_id')}}';
            let distributorid = '{{distributor.id}}';
            let clinicid = '{{clinic_id}}';

            if(is_order_list != null && '{{ app.request.get('distributor_id') }}' > 0) {

                getOrdersList('{{ app.request.get('distributor_id') }}', 1);
            }

            if(is_order_detail != null && orderid > 0 && distributorid > 0 && clinicid > 0) {

                getOrderDetails(orderid, distributorid, clinicid);
            }

            function getOrderDetails(order_id, distributor_id, clinic_id){

                account_settings.hide();
                about.hide();
                operating_hours.hide();
                refund_policy.hide();
                sales_tax_policy.hide();
                shipping_policy.hide();
                inventory.hide();
                inventoryList.hide();
                inventory_item.hide();
                users.hide();
                order_container.show();

                $.ajax({
                    url: "{{ path('distributor_get_order_details') }}",
                    type: 'POST',
                    data: {
                        order_id: order_id,
                        permissions: '{{ permissions|json_encode }}',
                    },
                    dataType: 'json',
                    beforeSend: function (){

                        isLoading(true);
                    },
                    complete: function(e, xhr, settings){
                        if(e.status === 500){
                            window.location.href = '{{ path('distributor_error_500') }}';
                        }
                    },
                    success: function (response) {

                        // Reset page load time for refresh button alert
                        date_time = date.getFullYear() +'-'+ (date.getMonth() + 1) +'-'+ date.getDate() +' '+ String(date.getHours()).padStart(2, "0") + ":" + String(date.getMinutes()).padStart(2, "0") +':'+ String(date.getSeconds()).padStart(2, '0');
                        sessionStorage.setItem('date_time', date_time);

                        $('#order_container').empty().append(response);
                        $('#distributor_chat_inner').scrollTop($('#distributor_chat_inner').prop("scrollHeight"));
                        popOver();
                        getChat(order_id, distributor_id, clinic_id)
                        $('#chat_pulse').hide();

                        var maxWidth = Math.max.apply( null, $( '.badge' ).map( function () {
                            return $( this ).outerWidth( true );
                        }).get() );

                        $('.badge').css({'width':maxWidth+'px'});

                        isLoading(false);
                    }
                });
            }
            $(document).on('click', '.order_detail_link, .refresh-distributor-order', function (e){

                e.preventDefault();

                let order_id = $(this).data('order-id');
                let clinic_id = $(this).data('clinic-id');
                let distributor_id = $(this).data('distributor-id');

                sessionStorage.setItem('order_id', order_id);
                window.history.pushState(null, "Fluid", '/distributors/order/'+ order_id);

                getOrderDetails(order_id, distributor_id, clinic_id);
                checkLastModified(order_id);
            });

            function getLastModified(order_id){

                session_date_time = sessionStorage.getItem('date_time');

                $.ajax({
                    url: "{{ path('get_order_last_update') }}",
                    type: 'POST',
                    cache: false,
                    timeout: 10000,
                    data: {
                        order_id: order_id
                    },
                    success: function (response) {
                        console.log(response +' '+ session_date_time);
                        if (response > session_date_time) {
                            console.log('add class');
                            $('.refresh-distributor-order').removeClass('blinking-text').addClass('blinking-text');

                            date = new Date();
                            date_time = date.getFullYear() +'-'+ (date.getMonth() + 1) +'-'+ date.getDate() +' '+ String(date.getHours()).padStart(2, "0") + ":" + String(date.getMinutes()).padStart(2, "0") +':'+ String(date.getSeconds()).padStart(2, '0');

                            sessionStorage.setItem('date_time', date_time);

                        }
                    }
                });
            };

            function checkLastModified(order_id) {
                setInterval(function(){ getLastModified(order_id, distributor_id); }, 5000);
            }

            let chat_pulse = $('#chat_pulse');
            let chat_field = $('#chat_field');
            let order_id = $('#chat_field').data('order-id');
            let distributor_id = $('#chat_field').data('distributor-id');

            $.ajax({
                url: "{{ path('is_typing') }}",
                type: 'POST',
                dataType: 'json',
                data: {
                    order_id: order_id,
                    distributor_id: distributor_id,
                    is_typing: 0,
                },
                success: function (response) {

                    $('#chat_pulse').hide();
                }
            });
            $(document).on('click','#chat_field', function () {

                chat_pulse = $('#chat_pulse');
                chat_field = $('#chat_field');
                order_id = $(this).data('order-id');
                distributor_id = $(this).data('distributor-id');

                $.ajax({
                    url: "{{ path('is_typing') }}",
                    type: 'POST',
                    dataType: 'json',
                    data: {
                        order_id: order_id,
                        distributor_id: distributor_id,
                        is_clinic: 0,
                        is_distributor: 1,
                        is_typing: 1,
                    },
                    success: function (response) {

                        if(response.clinic_is_typing > 0) {

                            $('#chat_pulse').show();

                        } else {

                            $('#chat_pulse').hide();
                        }
                    }
                });
            });
            $(document).on('blur','#chat_field', function (){

                $.ajax({
                    url: "{{ path('is_typing') }}",
                    type: 'POST',
                    dataType: 'json',
                    data: {
                        order_id: order_id,
                        distributor_id: distributor_id,
                        is_clinic: 0,
                        is_distributor: 1,
                        is_typing: 0,
                    },
                    success: function (response) {

                        $(chat_pulse).hide();
                    }
                });
            });
            $(document).on('click', '#btn_chat_send', function (e){

                e.preventDefault();

                let message = $('#chat_field').val();

                if(message.length > 0){

                    $.ajax({
                        url:"{{ path('clinic_send_message') }}",
                        type: 'POST',
                        dataType: 'json',
                        data: {
                            distributor: 1,
                            clinic: 0,
                            distributor_id: $(this).data('distributor-id'),
                            message: message,
                            order_id: $(this).data('order-id')
                        },
                        success: function(response) {
                            $('#distributor_chat_container').empty().append(response);
                            $('#distributor_chat_inner').scrollTop($('#distributor_chat_inner').prop("scrollHeight"));
                            $('#chat_field').val('');
                            $('#chat_pulse').hide();
                        }
                    });
                }
            });
            $(document).on('click', '#order_send_notification', function (e){

                e.preventDefault();

                let order_id = $(this).data('order-id');
                let distributor_id = $(this).data('distributor-id');
                let clinic_id = $(this).data('clinic-id');

                if(order_id > 0 && distributor_id > 0){

                    $.ajax({
                        url:"{{ path('distributor_send_order_notification') }}",
                        type: 'POST',
                        dataType: 'json',
                        data: {
                            order_id: order_id,
                            distributor_id: distributor_id,
                            clinic_id: clinic_id
                        },
                        beforeSend: function () {
                            $("div.spanner").addClass("show");
                            $("div.overlay").addClass("show");
                        },
                        success: function(response) {
                            $("div.spanner").removeClass("show");
                            $("div.overlay").removeClass("show");
                            getFlash(response);
                        }
                    });
                }
            });
            $(document).on('click', '.btn_confirm', function (e){

                e.preventDefault();

                let item_id = $(this).data('item-id');

                if(item_id > 0){

                    $.ajax({
                        url:"{{ path('distributor_update_order_item_status') }}",
                        type: 'POST',
                        dataType: 'json',
                        data: {
                            item_id: item_id,
                            confirmed_status: 1
                        },
                        beforeSend: function () {
                            $("div.spanner").addClass("show");
                            $("div.overlay").addClass("show");
                        },
                        success: function(response) {
                            getFlash(response.flash);
                            getOrderDetails(response.order_id, response.distributor_id, response.clinic_id);
                            $("div.spanner").removeClass("show");
                            $("div.overlay").removeClass("show");
                        }
                    });
                }
            });
            $(document).on('click', '.btn_pending', function (e){

                e.preventDefault();

                let item_id = $(this).data('item-id');

                if(item_id > 0){

                    $.ajax({
                        url:"{{ path('distributor_update_order_item_status') }}",
                        type: 'POST',
                        dataType: 'json',
                        data: {
                            item_id: item_id,
                            confirmed_status: 0
                        },
                        beforeSend: function () {
                            $("div.spanner").addClass("show");
                            $("div.overlay").addClass("show");
                        },
                        success: function(response) {
                            getFlash(response.flash);
                            getOrderDetails(response.order_id, response.distributor_id, response.clinic_id);
                            $("div.spanner").removeClass("show");
                            $("div.overlay").removeClass("show");
                        }
                    });
                }
            });
            $(document).on('change', '.expiry-date', function (e){

                e.preventDefault();

                let item_id = $(this).data('item-id');
                let expiry_date = $(this).val();

                if(item_id > 0){

                    $.ajax({
                        url:"{{ path('distributor_update_expiry_date') }}",
                        type: 'POST',
                        dataType: 'json',
                        data: {
                            item_id: item_id,
                            expiry_date: expiry_date
                        },
                        beforeSend: function () {
                            $("div.spanner").addClass("show");
                            $("div.overlay").addClass("show");
                        },
                        success: function(response) {
                            getFlash(response.flash);
                            getOrderDetails(response.order_id, response.distributor_id, response.clinic_id);
                            $("div.spanner").removeClass("show");
                            $("div.overlay").removeClass("show");
                        }
                    });
                }
            });
            $(document).on('change', '.item-price', function (e){

                e.preventDefault();

                let item_id = $(this).data('item-id');
                let price = $(this).val();

                if(item_id > 0){

                    $.ajax({
                        url:"{{ path('distributor_update_price') }}",
                        type: 'POST',
                        dataType: 'json',
                        data: {
                            item_id: item_id,
                            price: price
                        },
                        beforeSend: function () {
                            $("div.spanner").addClass("show");
                            $("div.overlay").addClass("show");
                        },
                        success: function(response) {
                            getFlash(response.flash);
                            getOrderDetails(response.order_id, response.distributor_id, response.clinic_id);
                            $("div.spanner").removeClass("show");
                            $("div.overlay").removeClass("show");
                        }
                    });
                }
            });
            $(document).on('change', '.item-qty', function (e){

                e.preventDefault();

                let item_id = $(this).data('item-id');
                let qty = $(this).val();

                if(item_id > 0){

                    $.ajax({
                        url:"{{ path('distributor_update_qty') }}",
                        type: 'POST',
                        dataType: 'json',
                        data: {
                            item_id: item_id,
                            qty: qty
                        },
                        beforeSend: function () {
                            $("div.spanner").addClass("show");
                            $("div.overlay").addClass("show");
                        },
                        success: function(response) {
                            getFlash(response.flash);
                            getOrderDetails(response.order_id, response.distributor_id, response.clinic_id);
                            $('#basket_container').empty().append(response.orders);
                            $("div.spanner").removeClass("show");
                            $("div.overlay").removeClass("show");
                        }
                    });
                }
            });
            $(document).on('submit', '#form_distributor_orders', function (e){

                e.preventDefault();

                let data = new FormData(this);
                let product_id = data.getAll('product_id[]');
                let exp_dates = data.getAll('expiry_date[]');
                let prices = data.getAll('price[]');
                let qtys = data.getAll('qty[]');
                let is_valid = true;

                for($i = 0; $i < product_id.length; $i++){

                    let error_exp_date = $('#error_expiry_date_'+ product_id[$i]);
                    let error_price = $('#error_price_'+ product_id[$i]);
                    let error_qty = $('#error_qty_'+ product_id[$i]);
                    let exp_date = exp_dates[$i];
                    let price = prices[$i];
                    let qty = qtys[$i];

                    error_exp_date.hide();
                    error_price.hide();
                    error_qty.hide();

                    if((exp_date == '' || exp_date == 'undefined') && exp_date !== 0){

                        error_exp_date.show();
                        is_valid = false;
                    }

                    if(price == '' || price == 'undefined'){

                        error_price.show();
                        is_valid = false;
                    }

                    if(qty == '' || qty == 'undefined'){

                        error_qty.show();
                        is_valid = false;
                    }
                }

                if(is_valid) {

                    $.ajax({
                        url: "{{ path('distributor_update_order') }}",
                        type: 'POST',
                        contentType: false,
                        processData: false,
                        cache: false,
                        timeout: 600000,
                        dataType: 'json',
                        data: data,
                        beforeSend: function () {
                            $("div.spanner").addClass("show");
                            $("div.overlay").addClass("show");
                        },
                        success: function (response) {
                            getFlash(response.flash);
                            getOrderDetails(response.order_id, response.distributor_id, response.clinic_id);
                            $("div.spanner").removeClass("show");
                            $("div.overlay").removeClass("show");

                            date = new Date();
                            date_time = date.getFullYear() +'-'+ (date.getMonth() + 1) +'-'+ date.getDate() +' '+ String(date.getHours()).padStart(2, "0") + ":" + String(date.getMinutes()).padStart(2, "0") +':'+ String(date.getSeconds()).padStart(2, '0');

                            sessionStorage.setItem('date_time', date_time);
                        }
                    });
                }
            });

            function getMessages(distributor_id, clinic_id){

                let uri = window.location.pathname;
                let is_order_detail = uri.match('/[a-zA-Z]+/[a-zA-Z]+/[0-9]+');
                order_id = sessionStorage.getItem('order_id');

                if(is_order_detail != null && order_id > 0) {

                    let messages_sent = $('.speech-bubble-right').length;
                    let messages_received = $('.speech-bubble-left').length;
                    let total_messages = messages_sent + messages_received;

                    $.ajax({
                        url: "{{ path('get_messages') }}",
                        type: 'GET',
                        cache: false,
                        timeout: 10000,
                        data: {
                            distributor: 1,
                            clinic: 0,
                            order_id: order_id,
                            distributor_id: distributor_id,
                            clinic_id: clinic_id,
                            total_messages: total_messages
                        },
                        success: function (response) {

                            if (response.messages.length > 0) {

                                $('#distributor_chat_container').empty().append(response.messages);
                                $('#distributor_chat_inner').scrollTop($('#distributor_chat_inner').prop("scrollHeight"));
                            }

                            if (response.is_typing == 1) {

                                $('#chat_pulse').show();

                            } else {

                                $('#chat_pulse').hide();
                            }
                        }
                    });
                }
            };

            function getChat(order_id, distributor_id, clinic_id) {
                get_messages = setInterval(function(){
                    getMessages(distributor_id, clinic_id);
                }, 1000);
            }
            {# End Orders #}

            {# Users #}

            {# Customers #}
            function getCustomersList(){

                $.ajax({
                    url: "{{ path('zoho_customers') }}",
                    type: 'POST',
                    dataType: 'json',
                    beforeSend: function () {
                        $("div.spanner").addClass("show");
                        $("div.overlay").addClass("show");
                    },
                    complete: function(e, xhr, settings){
                        if(e.status === 500){
                            window.location.href = '{{ path('distributor_error_500') }}';
                        }
                    },
                    success: function (response) {
                        $('#customer_container').empty().append(response);
                        $('.distributor-right-col').animate ({scrollTop:0}, 200);
                        account_settings.hide();
                        about.hide();
                        operating_hours.hide();
                        refund_policy.hide();
                        sales_tax_policy.hide();
                        shipping_policy.hide();
                        inventory.hide();
                        inventoryList.hide();
                        inventory_item.hide();
                        users.hide();
                        order_container.hide();
                        customerContainer.show();
                        $("div.spanner").removeClass("show");
                        $("div.overlay").removeClass("show");

                        window.history.pushState(null, "Fluid", '/distributors/customers/1');
                    }
                });
            }

            $(document).on('change', '#trade_license_file', function() {

                let fp = $("#trade_license_file");
                let lg = fp[0].files.length; // get length
                let items = fp[0].files;
                let errorTradeLicense = $('#error_trade_license_file');
                let fileName = '';
                let fileSize = '';
                let fileType = '';

                errorTradeLicense.hide().append('Required Field');

                if (lg > 0) {
                    for (let i = 0; i < lg; i++) {
                        fileName = items[i].name; // get file name
                        fileSize = items[i].size; // get file size
                        fileType = items[i].type; // get file type
                    }
                }

                if(fileType != 'application/pdf')
                {
                    fp.val('');
                    errorTradeLicense.empty().append('Please select a PDF document').show();
                }
            });
            {# End Update Personal Information #}

            {# Invenory / Distributor Products #}
            let trackingId = '{{ distributor.tracking.id|default(0) }}';

            if(trackingId == 1)
            {
                $('#unit_price').attr('disabled', true);
                $('#stock_count').attr('disabled', true);
            }
            $('#form_inventory_item').submit(function(e){

                e.preventDefault();

                let isValid = true;
                let unitPrice = $('#unit_price').val();
                let itemId = $('#item_id').val();
                let errorUnitPrice = $('#error_unit_price');
                let errorItemId = $('#error_item_id');
                let trackingId = $('#tracking_id').val();

                errorUnitPrice.hide();
                errorItemId.hide();

                if((unitPrice == '' || unitPrice == 'undefined') && trackingId > 1){

                    errorUnitPrice.show();
                    isValid = false;
                }

                if(itemId == '' || itemId == 'undefined'){

                    errorItemId.show();
                    isValid = false;
                }

                if(isValid == true){

                    let data = new FormData(this);

                    $.ajax({
                        url: "{{ path('distributor_inventory_update') }}",
                        type: 'POST',
                        contentType: false,
                        processData: false,
                        cache: false,
                        timeout: 600000,
                        dataType: 'json',
                        data: data,
                        beforeSend: function () {
                            isLoading(true);
                        },
                        complete: function(e, xhr, settings){
                            if(e.status === 500){
                                window.location.href = '{{ path('distributor_error_500') }}';
                            }
                        },
                        success: function (response) {
                            getFlash(response.flash);
                            $('#unit_price').val(response.unitPrice);
                            $('#stock_count').val(response.stockLevel);
                            isLoading(false);
                        }
                    });
                }
            });
            $(document).on('click', '#import_products', function(e){

                e.preventDefault();

                $.ajax({
                    url: "{{ path('distributor_import_products') }}",
                    type: 'POST',
                    dataType: 'json',
                    beforeSend: function (){
                        isLoading(true);
                    },
                    complete: function(e, xhr, settings){
                        if(e.status === 500){
                            window.location.href = '{{ path('distributor_error_500') }}';
                        }
                    },
                    success: function (response) {

                        isLoading(false);
                        getFlash(response.flash);
                    }
                });
            });
            {#$("#search_field").keyup(function(){#}

            {#    $.ajax({#}
            {#        type: "POST",#}
            {#        url: "{{ path('distributor_inventory_search') }}",#}
            {#        data:'keyword='+$(this).val(),#}
            {#        success: function(data){#}
            {#            $("#suggestion_field").show();#}
            {#            $("#suggestion_field").html(data);#}
            {#        }#}
            {#    });#}
            {#});#}
            $(document).on('click', '.search-item', function () {

                $('.clear-search').removeClass('hidden');
                $('.search-div').removeClass('col-12').addClass('col-11');
            });
            $(document).on('submit', '#upload_csv', function (e) {

                e.preventDefault();

                let file = $('#file').val();
                let errorFile = $('#error_file');
                let isValid = true;

                errorFile.hide();

                if(file == '' || file == 'undefined'){

                    errorFile.show();
                    isValid = false;
                }

                if(isValid) {

                    let data = new FormData(this);

                    $.ajax({
                        url: "{{ path('upload_inventory_csv') }}",
                        type: 'POST',
                        contentType: false,
                        processData: false,
                        cache: false,
                        timeout: 600000,
                        dataType: 'json',
                        data: data,
                        beforeSend: function () {
                            isLoading(true);
                        },
                        complete: function (e) {
                            if (e.status === 500) {
                                window.location.href = '{{ path('distributor_error_500') }}';
                            }
                        },
                        success: function (response) {

                            $('#modal_upload_file').modal('toggle');
                            $('#file').val('');
                            getFlash(response.flash, response.flashStyle);
                            isLoading(false);
                        }
                    });
                }
            });
            $(document).on('change', '#tracking_id', function () {

                let trackingId = $(this).val();

                if(trackingId > 0){

                    $.ajax({
                        url: "{{ path('update_tracking_id') }}",
                        type: 'POST',
                        data: {
                            'distributor-id': '{{ app.user.distributor.id|default(0) }}',
                            'tracking-id': trackingId,
                        },
                        dataType: 'json',
                        beforeSend: function () {
                            isLoading(true);
                        },
                        complete: function(e, xhr, settings){
                            if(e.status === 500){
                                window.location.href = '{{ path('distributor_error_500') }}';
                            }
                        },
                        success: function (response) {

                            if(trackingId == 1)
                            {
                                $('#semi_tracked_row').hide(700);
                                $('#unit_price').attr('disabled', true);
                                $('#stock_count').attr('disabled', true);
                                $('#zoho_container').hide(700);
                                $('#import_products_row').show(700);

                            }

                            if(trackingId == 2)
                            {
                                $('#semi_tracked_row').show(700);
                                $('#unit_price').attr('disabled', true);
                                $('#stock_count').attr('disabled', true);
                                $('#import_products_row').hide(700);
                            }

                            if(trackingId == 3)
                            {
                                $('#semi_tracked_row').hide(700);
                                $('#unit_price').attr('disabled', false);
                                $('#stock_count').attr('disabled', false);
                                $('#zoho_container').hide(700);
                                $('#import_products_row').hide(700);
                            }

                            getFlash(response);
                            isLoading(false);
                        }
                    });
                }
            });
            {# End Invenory / Distributor Products #}

            {# Users #}
            $('#users_link').click(function (e){

                e.preventDefault();

                account_settings.hide();
                about.hide();
                operating_hours.hide();
                refund_policy.hide();
                sales_tax_policy.hide();
                shipping_policy.hide();
                
                
                
                inventory_item.hide();
                users.show();
                order_container.hide();
                customerContainer.hide();
            });
            $(document).on('click', '.user-pagination', function (e){

                e.preventDefault();
                let page_id = $(this).data('page-id');

                $.ajax({
                    url: "{{ path('distributor_refresh_users') }}",
                    type: 'POST',
                    dataType: 'json',
                    data: {
                        page_id: page_id
                    },
                    beforeSend: function (){
                        $("div.spanner").addClass("show");
                        $("div.overlay").addClass("show");
                    },
                    success: function (response) {
                        $('#users_list').empty().append(response);
                        $("div.spanner").removeClass("show");
                        $("div.overlay").removeClass("show");
                    }
                });
            });
            {# End Users #}

            {# Customers #}
            $('#customers_link').click(function (e){

                e.preventDefault();

                account_settings.hide();
                about.hide();
                operating_hours.hide();
                refund_policy.hide();
                sales_tax_policy.hide();
                shipping_policy.hide();
                inventory_item.hide();
                users.hide();
                order_container.hide();
                customerContainer.show();

                getCustomersList();
            });
            $(document).on('click', '.customer-pagination', function (e){

                e.preventDefault();
                let page_id = $(this).data('page-id');

                $.ajax({
                    url: "{{ path('distributor_refresh_users') }}",
                    type: 'POST',
                    dataType: 'json',
                    data: {
                        page_id: page_id
                    },
                    beforeSend: function (){
                        $("div.spanner").addClass("show");
                        $("div.overlay").addClass("show");
                    },
                    success: function (response) {
                        $('#users_list').empty().append(response);
                        $("div.spanner").removeClass("show");
                        $("div.overlay").removeClass("show");
                    }
                });
            });
            $(document).on('click', '.modal-customer-connect', function (e) {

                e.preventDefault();

                let clinicId = $(this).attr('data-clinic-id');
                let distributorId = $(this).attr('data-distributor-id');
                let clinic = $(this).attr('data-clinic');
                let customerId = $(this).attr('data-customer-id');

                $('#btn_save_customer_connect').attr('data-clinic-id', clinicId);
                $('#btn_save_customer_connect').attr('data-distributor-id', distributorId);
                $('#btn_save_customer_connect').attr('data-clinic-name', clinic);
                $('#connect_clinic_name').empty().append(clinic);
                $('#customer_id').val(customerId);
            });
            $(document).on('click', '#btn_save_customer_connect', function (){

                let customerId = $('#customer_id').val();
                let clinicId = $(this).attr('data-clinic-id');
                let distributorId = $(this).attr('data-distributor-id');
                let errorCustomerId = $('#error_customer_id');
                let isValid = true;

                errorCustomerId.hide();

                if(customerId == '' || customerId == 'undefined'){

                    errorCustomerId.show();
                    isValid = false;
                }

                if(isValid){

                    $.ajax({
                        url: "{{ path('distributors_activate_connection') }}",
                        type: 'POST',
                        dataType: 'json',
                        data: {
                            'customer-id': customerId,
                            'distributor-id': distributorId,
                            'clinic-id': clinicId
                        },
                        beforeSend: function (){
                            $("div.spanner").addClass("show");
                            $("div.overlay").addClass("show");
                        },
                        success: function (response) {

                            getFlash(response);
                            isLoading(false);
                            $('#modal_connect_customer').modal('toggle');
                        }
                    });
                }
            });
            $(document).on('click', '.ignore-icon', function (e) {

                e.preventDefault();

                let clinicId = $(this).attr('data-clinic-id');
                let distributorId = $(this).attr('data-distributor-id');
                let link = $(this);

                if((clinicId != '' || clinicId != 'undefined') && (distributorId != '' || distributorId != 'undefined')){

                    $.ajax({
                        url: "{{ path('distributors_ignore_connection') }}",
                        type: 'POST',
                        dataType: 'json',
                        data: {
                            'distributor-id': distributorId,
                            'clinic-id': clinicId
                        },
                        beforeSend: function (){
                            $("div.spanner").addClass("show");
                            $("div.overlay").addClass("show");
                        },
                        success: function (response) {

                            link.find('.fa-bell-slash').replaceWith(response.icon);

                            getFlash(response.flash);
                            isLoading(false);
                        }
                    });

                } else {

                    alert('An error occurred');
                }
            });
            {# End Customers #}

            {# Clear Search #}
            $(document).on('click', '#inventory_clear', function (e){

                e.preventDefault();
                $('#search_field').val('');
                $('#product_name').empty().append('Manage Your Inventory');
                $('#inventory_item').hide();
                $('#inventory_btn').hide();
            });

            {# Notifications #}
            $('#notifications_panel').hide();
            $(document).on('click', 'a', function (){

                let name = $(this).attr('name');

                if(name != 'notifications'){

                    $('#notifications_panel').hide();
                }

            });
            $(document).on('click', '.btn-notifications', function (e){

                e.preventDefault();
                getNotifications();

                $('#notifications_panel').slideToggle(700);
            });
            $(document).on('click', '.order_notification_alert', function (e){

                e.preventDefault();

                order_id = $(this).data('order-id');
                distributor_id = $(this).data('distributor-id');
                let clinic_id = $(this).data('clinic-id');

                getOrderDetails(order_id, distributor_id, clinic_id);

                let notificationId = $(this).data('notification-id');

                $.ajax({
                    url: "{{ path('delete_notifications') }}",
                    type: 'POST',
                    dataType: 'json',
                    data: {
                        'notification-id': notificationId,
                        'type': 'clinic',
                    }
                });

                window.history.pushState(null, "Fluid", '/distributors/order/'+ order_id +'/'+ distributor_id);
            });
            $(document).on('click', '.notification-panel', function (e){

                e.preventDefault();

                let notificationId = $(this).data('notification-id');

                $.ajax({
                    url: "{{ path('delete_notifications') }}",
                    type: 'POST',
                    cache: false,
                    timeout: 600000,
                    dataType: 'json',
                    data: {
                        'notification-id': notificationId,
                        'type': 'distributor'
                    },
                    success: function (response) {

                        getNotifications();
                    }
                });
            });

            function getNotifications(){

                $.ajax({
                    url: "{{ path('get_order_notification') }}",
                    type: 'GET',
                    cache: false,
                    timeout: 600000,
                    dataType: 'json',
                    data: {
                        'type': 'distributor',
                        'id': '{{ app.user.distributor.id|default(0) }}'
                    },
                    success: function (response) {

                        if(response.count > 0){

                            $('#notifications_icon').addClass('text-secondary');

                        } else {

                            $('#notifications_icon').removeClass('text-secondary');
                        }

                        $('#notifications_panel').empty().append(response.alert);
                    }
                });
            }

            {# Popovers #}
            function popOver() {
                var popoverTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="popover"]'))
                var popoverList = popoverTriggerList.map(function (popoverTriggerEl) {
                    return new bootstrap.Popover(popoverTriggerEl)
                })
            }

            {# Clode Flash Message #}
            $('#flash').click(function (){
                $('#flash').addClass('hidden');
            });

            function isLoading(status){

                if(status) {

                    $("div.spanner").addClass("show");
                    $("div.overlay").addClass("show");

                } else {

                    $("div.spanner").removeClass("show");
                    $("div.overlay").removeClass("show");
                }
            }

            {# Popovers #}
            function popOver() {
                var popoverTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="popover"]'))
                var popoverList = popoverTriggerList.map(function (popoverTriggerEl) {
                    return new bootstrap.Popover(popoverTriggerEl)
                })
            }
        });

        var popoverTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="popover"]'))
        var popoverList = popoverTriggerList.map(function (popoverTriggerEl) {
            return new bootstrap.Popover(popoverTriggerEl)
        })
    </script>
{% endblock %}
